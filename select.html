<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Bild wählen — Instagram Simulation</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#fafafa;margin:0}
.wrap{max-width:760px;margin:18px auto;padding:12px;text-align:center}
h1{font-size:1.1rem}
.grid{display:flex;flex-wrap:wrap;gap:10px;justify-content:center}
.choice{width:46%;max-width:220px;height:180px;object-fit:cover;border-radius:10px;cursor:pointer;border:3px solid transparent}
.choice.sel{border-color:#0d6efd}
.btn{display:inline-block;padding:10px 14px;background:#0d6efd;color:#fff;border-radius:6px;border:none;cursor:pointer;margin-top:12px}
.note{color:#666;font-size:0.9rem;margin-top:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Bild auswählen</h1>
  <div id="grid" class="grid"></div>
  <button id="next" class="btn">Weiter</button>
  <div class="note">Wenn nichts erscheint: prüfe, ob Bilder im Ordner images/ mit Namen like <code>self_1.png</code> oder <code>self1.png</code> existieren.</div>
</div>

<script>
const params = new URLSearchParams(location.search);
const p = params.get('p') || '1';
const c = params.get('c') || 'i';
const grid = document.getElementById('grid');
let chosen = null;

function findImagesByPrefixes(prefixes, exts, maxN, onFound, onDone){
  (async ()=>{
    let found = [];
    for(const prefix of prefixes){
      for(let i=1;i<=maxN;i++){
        for(const ext of exts){
          const url = `images/${prefix}${i}${ext}`;
          // eslint-disable-next-line no-await-in-loop
          const ok = await testImage(url);
          if(ok){
            found.push(url); onFound(url);
          }
        }
      }
    }
    onDone(found);
  })();
}

function testImage(url){
  return new Promise(resolve=>{
    const img = new Image();
    img.onload = ()=>resolve(true);
    img.onerror = ()=>resolve(false);
    img.src = url;
  });
}

function addChoice(url){
  const img = document.createElement('img');
  img.src = url;
  img.className = 'choice';
  if(chosen===null){ chosen = url; img.classList.add('sel'); }
  img.onclick = ()=>{
    chosen = url;
    document.querySelectorAll('.choice').forEach(x=>x.classList.remove('sel'));
    img.classList.add('sel');
  };
  grid.appendChild(img);
}

// try selfie prefixes and neutral prefixes
const exts = ['.png','.jpg','.jpeg','.webp'];
const selfPrefixes = ['self_','self','selfie_','selfie'];
const neutralPrefixes = ['neutral_','neutral'];

const usePrefixes = (p==='1') ? selfPrefixes : neutralPrefixes;

findImagesByPrefixes(usePrefixes, exts, 20,
  (url)=>addChoice(url),
  (found)=> {
    if(found.length===0){
      // fallback: try raw filenames like '1.png' etc (unlikely) or inform user
      const msg = document.createElement('div'); msg.style.color='#a00'; msg.style.marginTop='8px';
      msg.innerText = 'Keine passenden Bilder gefunden. Bitte prüfen Sie images/ Ordner.';
      grid.parentNode.insertBefore(msg, grid.nextSibling);
    }
  }
);

document.getElementById('next').addEventListener('click', ()=>{
  if(!chosen){
    alert('Bitte wähle zuerst ein Bild.');
    return;
  }
  localStorage.setItem('sim_chosen_image', chosen);
  location.href = `post.html?p=${encodeURIComponent(p)}&c=${encodeURIComponent(c)}`;
});
</script>
</body>
</html>
